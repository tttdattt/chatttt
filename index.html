<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Management System - Blacklist Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --text: #f8fafc; --accent: #38bdf8; --danger: #ef4444; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); display: grid; grid-template-columns: 320px 1fr 350px; height: 100vh; overflow: hidden; }
        section { background: var(--panel); display: flex; flex-direction: column; border-right: 1px solid #334155; overflow: hidden; }
        .scroll { flex: 1; overflow-y: auto; padding: 20px; scrollbar-width: none; }
        .scroll::-webkit-scrollbar { display: none; }
        .card { background: #0f172a; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #334155; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; background: #0f172a; color: white; border: 1px solid #334155; box-sizing: border-box; }
        .btn { width: 100%; background: var(--accent); color: #000; border: none; padding: 10px; cursor: pointer; font-weight: bold; border-radius: 5px; }
        .admin-btn { font-size: 0.7rem; padding: 4px; cursor: pointer; border-radius: 3px; border: none; color: white; }
        .ban-notice { color: var(--danger); font-weight: bold; border: 2px solid var(--danger); padding: 10px; border-radius: 10px; text-align: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<section>
    <div style="padding:20px; border-bottom:1px solid #334155;">Rooms</div>
    <div class="scroll">
        <div id="create-box" class="card">
            <input type="text" id="r-name" placeholder="éƒ¨å±‹å">
            <button class="btn" onclick="createRoom()">ï¼‹ éƒ¨å±‹ä½œæˆ</button>
        </div>
        <div id="room-list"></div>
    </div>
</section>

<section style="background:#0f172a;">
    <div id="room-title" style="padding:20px; border-bottom:1px solid #334155;">éƒ¨å±‹æœªé¸æŠ</div>
    <div id="msg-list" class="scroll" style="padding:20px;"></div>
    <div style="padding:20px; background:var(--panel);">
        <input type="text" id="chat-in" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." onkeypress="if(event.key==='Enter') send()">
    </div>
</section>

<section>
    <div style="padding:20px; border-bottom:1px solid #334155;">Settings</div>
    <div class="scroll">
        <div id="ban-display" class="card hidden">
            <div class="ban-notice">âš ï¸ ã‚ãªãŸã¯ã‚µã‚¤ãƒˆæ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™</div>
        </div>

        <div class="card">
            <h4 style="margin:0 0 10px 0">Profile</h4>
            <input type="text" id="u-name" value="Dat" onchange="nameUpdate()">
        </div>

        <div id="auth-box" class="card">
            <h4 style="margin:0 0 10px 0">Login</h4>
            <input type="password" id="a-code" placeholder="æš—å·å…¥åŠ›">
            <button class="btn" onclick="auth()">èªè¨¼</button>
        </div>

        <div id="admin-tools" class="hidden">
            <div class="card">
                <p style="font-size:0.8rem">å•ã„åˆã‚ã›: Discord dr.3ko_</p>
                <button class="btn" style="background:var(--danger);color:#fff;" onclick="delRoom()">ğŸ—‘ï¸ éƒ¨å±‹å‰Šé™¤</button>
            </div>
            <div class="card">
                <h4 style="margin:0 0 10px 0">Current Users</h4>
                <div id="user-ctrl-list" style="font-size:0.75rem;"></div>
            </div>
            <div class="card" style="border-color: var(--danger);">
                <h4 style="margin:0 0 10px 0; color: var(--danger);">Blacklist</h4>
                <div id="blacklist-ui" style="font-size:0.75rem;"></div>
            </div>
            <div style="text-align:center; font-size:0.8rem; opacity:0.7;">ğŸ‘‘ ç·è²¬ä»»è€…: ãƒ€ãƒƒãƒˆ</div>
        </div>
    </div>
</section>

<script>
    const _sb = supabase.createClient('https://qvwfhesfjylkgmoscwsa.supabase.co', 'sb_publishable_Z-TH5yMPqJDGn2WGlzGrEQ_y8t-QAg8');
    
    let uid = localStorage.getItem('uid') || 'u-'+Math.random().toString(36).substr(2,9);
    localStorage.setItem('uid', uid);
    
    let isSiteBanned = false;
    let bannedRooms = JSON.parse(localStorage.getItem('br') || '[]');
    let role = "User", myName = "Dat", curRoomId = null, channel = null;

    async function checkSiteBan() {
        const { data } = await _sb.from('banned_users').select('uid').eq('uid', uid).single();
        if(data) {
            isSiteBanned = true;
            document.getElementById('ban-display').classList.remove('hidden');
        }
    }

    async function getRooms() {
        const { data } = await _sb.from('rooms').select('*');
        document.getElementById('room-list').innerHTML = data.map(r => `<div class="card" onclick="joinRoom('${r.id}','${r.name}')" style="cursor:pointer;">${r.name}</div>`).join('');
    }

    function auth() {
        if(isSiteBanned) return alert("BANä¸­ã¯ä¸å¯");
        const c = document.getElementById('a-code').value;
        if(c === 'datto0n0can') role = "Admin";
        else if(c === 'datto0n0fuku') role = "Fuku";
        else return alert("Invalid");
        document.getElementById('admin-tools').classList.remove('hidden');
        document.getElementById('auth-box').classList.add('hidden');
        updateBlacklistUI();
        if(curRoomId) sync();
    }

    function joinRoom(id, n) {
        if(isSiteBanned) return alert("ã‚µã‚¤ãƒˆã‹ã‚‰BANã•ã‚Œã¦ã„ã¾ã™");
        if(bannedRooms.includes(id)) return alert("éƒ¨å±‹ã‹ã‚‰è¿½æ”¾ã•ã‚Œã¦ã„ã¾ã™");
        curRoomId = id; document.getElementById('room-title').innerText = n;
        if(channel) _sb.removeChannel(channel);
        channel = _sb.channel(`r-${id}`, { config: { presence: { key: myName } } })
            .on('presence', { event: 'sync' }, () => updateAdminUI())
            .on('broadcast', { event: 'kick' }, p => {
                if(p.payload.uid === uid) {
                    bannedRooms.push(id); localStorage.setItem('br', JSON.stringify(bannedRooms));
                    alert("è¿½æ”¾ã•ã‚Œã¾ã—ãŸ"); location.reload();
                }
            })
            .on('broadcast', { event: 'site_ban' }, p => { if(p.payload.uid === uid) location.reload(); })
            .subscribe(async (s) => { if(s === 'SUBSCRIBED') sync(); });
    }

    async function sync() { if(channel) await channel.track({ uid, role }); }

    function updateAdminUI() {
        if(role === "User") return;
        const state = channel.presenceState();
        let html = "";
        for (const name in state) {
            state[name].forEach(p => {
                if(p.uid === uid) return;
                html += `<div style="margin-bottom:8px;">${name} <br>
                    <button class="admin-btn" style="background:orange" onclick="punish('kick','${p.uid}')">è¿½æ”¾</button>
                    <button class="admin-btn" style="background:red" onclick="siteBan('${p.uid}','${name}')">ã‚µã‚¤ãƒˆBAN</button>
                </div>`;
            });
        }
        document.getElementById('user-ctrl-list').innerHTML = html;
    }

    async function siteBan(targetUid, targetName) {
        if(!confirm(targetName + " ã‚’ã‚µã‚¤ãƒˆBANã—ã¾ã™ã‹ï¼Ÿ")) return;
        await _sb.from('banned_users').insert([{ uid: targetUid, user_name: targetName }]);
        channel.send({ type: 'broadcast', event: 'site_ban', payload: { uid: targetUid } });
        updateBlacklistUI();
    }

    async function updateBlacklistUI() {
        const { data } = await _sb.from('banned_users').select('*');
        document.getElementById('blacklist-ui').innerHTML = data.map(u => `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span>${u.user_name}</span>
                <button class="admin-btn" style="background:green" onclick="unban('${u.uid}')">è§£é™¤</button>
            </div>
        `).join('') || "ãªã—";
    }

    async function unban(targetUid) {
        await _sb.from('banned_users').delete().eq('uid', targetUid);
        updateBlacklistUI();
        alert("è§£é™¤ã—ã¾ã—ãŸ");
    }

    function punish(type, target) { channel.send({ type: 'broadcast', event: type, payload: { uid: target } }); }

    function createRoom() {
        if(isSiteBanned) return alert("BANã•ã‚Œã¦ã„ã¾ã™");
        const n = document.getElementById('r-name').value;
        if(n) _sb.from('rooms').insert([{ name: n, host_id: myName }]).then(() => getRooms());
    }

    function nameUpdate() { myName = document.getElementById('u-name').value; if(curRoomId) sync(); }

    window.onload = async () => {
        await checkSiteBan();
        getRooms();
    };
</script>
</body>
</html>