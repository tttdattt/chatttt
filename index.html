<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚·ãƒ³ãƒ—ãƒ«ãƒãƒ£ãƒƒãƒˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --text: #f8fafc; --accent: #38bdf8; --danger: #ef4444; --fuku: #f59e0b; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); display: grid; grid-template-columns: 320px 1fr 350px; height: 100vh; overflow: hidden; }
        section { background: var(--panel); display: flex; flex-direction: column; border-right: 1px solid #334155; overflow: hidden; }
        .header { padding: 20px; border-bottom: 1px solid #334155; font-weight: bold; background: rgba(0,0,0,0.1); }
        .scroll { flex: 1; overflow-y: auto; padding: 20px; scrollbar-width: none; }
        .scroll::-webkit-scrollbar { display: none; }
        .date-divider { text-align: center; margin: 20px 0; font-size: 0.75rem; opacity: 0.6; }
        .msg-container { display: flex; flex-direction: column; margin-bottom: 15px; }
        .u-name-label { font-size: 0.7rem; opacity: 0.7; margin: 0 10px 4px 10px; }
        .msg-bubble { display: flex; align-items: flex-end; gap: 6px; }
        .mine { align-items: flex-end; }
        .mine .msg-bubble { flex-direction: row-reverse; }
        .text { padding: 10px 16px; border-radius: 18px; max-width: 70%; font-size: 0.95rem; word-break: break-all; }
        .mine .text { background: var(--accent); color: #000; border-bottom-right-radius: 4px; }
        .other .text { background: #334155; color: #fff; border-bottom-left-radius: 4px; }
        .time { font-size: 0.65rem; opacity: 0.6; min-width: 35px; }
        .card { background: #0f172a; padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #334155; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; background: #0f172a; color: white; border: 1px solid #334155; box-sizing: border-box; border-radius: 8px; }
        .btn { width: 100%; background: var(--accent); color: #000; border: none; padding: 10px; cursor: pointer; font-weight: bold; border-radius: 8px; }
        .admin-btn { font-size: 0.65rem; padding: 4px 8px; cursor: pointer; border-radius: 4px; border: none; color: white; margin: 2px; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; margin-bottom: 10px; cursor: pointer; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<section>
    <div class="header">Rooms</div>
    <div class="scroll">
        <div class="card">
            <input type="text" id="r-name" placeholder="éƒ¨å±‹å">
            <input type="password" id="r-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(ä»»æ„)">
            <button class="btn" onclick="createRoom()">ï¼‹ éƒ¨å±‹ä½œæˆ</button>
        </div>
        <div id="room-list"></div>
    </div>
</section>

<section style="background:#0f172a;">
    <div id="room-title" class="header">éƒ¨å±‹ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
    <div id="msg-list" class="scroll"></div>
    <div id="input-area" class="hidden" style="padding:20px; background:var(--panel);">
        <input type="text" id="chat-in" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." onkeypress="if(event.key==='Enter') send()">
    </div>
</section>

<section>
    <div class="header">Settings & Admin</div>
    <div class="scroll">
        <div id="ban-display" class="card hidden" style="border-color:var(--danger);color:var(--danger);text-align:center;font-weight:bold;">âš ï¸ ã‚µã‚¤ãƒˆæ©Ÿèƒ½åˆ¶é™ä¸­</div>
        <div id="role-badge-area" class="hidden" style="text-align:center;"></div>
        <div class="card"><h4>Profile</h4><input type="text" id="u-name" value="Dat" onchange="nameUpdate()"></div>
        <div id="auth-box" class="card"><h4>Admin Login</h4><input type="password" id="a-code" placeholder="æš—å·å…¥åŠ›"><button class="btn" onclick="auth()">èªè¨¼</button></div>
        
        <div id="admin-tools" class="hidden">
            <div id="room-action-area" class="card hidden">
                <button class="btn" style="background:var(--danger);color:#fff;" onclick="delRoom()">ğŸ—‘ï¸ ç¾åœ¨ã®éƒ¨å±‹ã‚’å‰Šé™¤</button>
            </div>

            <div class="card">
                <p style="font-size:0.8rem; cursor:pointer;" onclick="copyDiscord()">ğŸ“ å•ã„åˆã‚ã›(Copy): <span style="color:var(--accent)">dr.3ko_</span></p>
            </div>
            <div class="card"><h4>Realtime Users</h4><div id="user-ctrl-list" style="font-size:0.75rem;"></div></div>
            <div class="card" style="border-color:var(--danger)"><h4>Blacklist</h4><div id="blacklist-ui" style="font-size:0.75rem;"></div></div>
            <div style="text-align:center; font-size:0.8rem; opacity:0.7; margin-top:20px;">ğŸ‘‘ ç·è²¬ä»»è€…: ãƒ€ãƒƒãƒˆ</div>
        </div>
    </div>
</section>

<script>
    const _sb = supabase.createClient('https://qvwfhesfjylkgmoscwsa.supabase.co', 'sb_publishable_Z-TH5yMPqJDGn2WGlzGrEQ_y8t-QAg8');
    let uid = localStorage.getItem('uid') || 'u-'+Math.random().toString(36).substr(2,9);
    localStorage.setItem('uid', uid);
    
    let role = localStorage.getItem('userRole') || "User";
    let isSiteBanned = false, bannedRooms = JSON.parse(localStorage.getItem('br') || '[]'), myName = localStorage.getItem('userName') || "Dat", curRoomId = null, channel = null;
    document.getElementById('u-name').value = myName;

    _sb.channel('db-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => fetchMessages())
        .on('postgres_changes', { event: '*', schema: 'public', table: 'rooms' }, () => getRooms())
        .on('postgres_changes', { event: '*', schema: 'public', table: 'banned_users' }, () => { checkSiteBan(); updateBlacklistUI(); })
        .subscribe();

    async function checkSiteBan() {
        const { data } = await _sb.from('banned_users').select('uid').eq('uid', uid).single();
        isSiteBanned = !!data;
        document.getElementById('ban-display').classList.toggle('hidden', !isSiteBanned);
    }

    async function getRooms() {
        const { data } = await _sb.from('rooms').select('*').order('created_at', { ascending: false });
        document.getElementById('room-list').innerHTML = data.map(r => `
            <div class="card" onclick="joinRoom('${r.id}','${r.name}','${r.password}')" style="cursor:pointer;">
                <b>${r.name}</b> ${r.password ? 'ğŸ”’' : ''}
            </div>`).join('');
    }

    function auth() {
        const c = document.getElementById('a-code').value;
        if(c === 'datto0n0can') applyRole("Admin");
        else if(c === 'datto0n0fuku') applyRole("Fuku");
        else alert("Invalid");
    }

    function applyRole(newRole) {
        role = newRole; localStorage.setItem('userRole', role);
        const badge = document.getElementById('role-badge-area');
        badge.innerHTML = `<span class="badge" style="background:${role === "Admin" ? 'var(--danger)' : 'var(--fuku)'}; color:white;" onclick="logout()">
            ${role === "Admin" ? 'ğŸ”´ ADMIN' : 'ğŸŸ  SUB ADMIN'} (Logout)</span>`;
        badge.classList.remove('hidden');
        document.getElementById('admin-tools').classList.remove('hidden');
        document.getElementById('auth-box').classList.add('hidden');
        updateBlacklistUI();
    }

    function logout() { if(confirm("Logout?")) { localStorage.removeItem('userRole'); location.reload(); } }

    async function joinRoom(id, n, p) {
        if(isSiteBanned) return alert("BANä¸­");
        if(bannedRooms.includes(id)) return alert("è¿½æ”¾ä¸­");
        if(p && role === "User") { const inputP = prompt("Password:"); if(inputP !== p) return alert("Wrong"); }
        
        curRoomId = id;
        document.getElementById('room-title').innerText = n;
        document.getElementById('input-area').classList.remove('hidden');
        // ä¿®æ­£ï¼šéƒ¨å±‹ã«å…¥ã£ãŸã‚‰å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆç®¡ç†æ¨©é™ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
        if(role !== "User") document.getElementById('room-action-area').classList.remove('hidden');

        if(channel) _sb.removeChannel(channel);
        fetchMessages();
        channel = _sb.channel(`r-${id}`, { config: { presence: { key: myName } } })
            .on('presence', { event: 'sync' }, () => updateAdminUI())
            .on('broadcast', { event: 'kick' }, p => { if(p.payload.uid === uid) { bannedRooms.push(id); localStorage.setItem('br', JSON.stringify(bannedRooms)); clearChat(); } })
            .subscribe(async (s) => { if(s === 'SUBSCRIBED') syncPresence(); });
    }

    function clearChat() {
        curRoomId = null;
        document.getElementById('room-title').innerText = "éƒ¨å±‹ã‚’é¸æŠã—ã¦ãã ã•ã„";
        document.getElementById('msg-list').innerHTML = "";
        document.getElementById('input-area').classList.add('hidden');
        document.getElementById('room-action-area').classList.add('hidden'); // ãƒœã‚¿ãƒ³éš ã™
        document.getElementById('user-ctrl-list').innerHTML = "";
    }

    async function fetchMessages() {
        if(!curRoomId) return;
        const { data } = await _sb.from('messages').select('*').eq('room_id', curRoomId).order('created_at', { ascending: true });
        let html = "", lastDate = null;
        data.forEach(m => {
            const d = new Date(m.created_at).toLocaleDateString('ja-JP');
            if(d !== lastDate) { html += `<div class="date-divider">${d}</div>`; lastDate = d; }
            const t = new Date(m.created_at).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            html += `<div class="msg-container ${m.user_name === myName ? 'mine' : 'other'}"><div class="u-name-label">${m.user_name}</div><div class="msg-bubble"><div class="text">${m.content}</div><div class="time">${t}</div></div></div>`;
        });
        document.getElementById('msg-list').innerHTML = html;
        document.getElementById('msg-list').scrollTop = document.getElementById('msg-list').scrollHeight;
    }

    async function syncPresence() { if(channel) await channel.track({ uid, role }); }

    function updateAdminUI() {
        if(!channel) return;
        const state = channel.presenceState();
        let html = "";
        for (const name in state) {
            state[name].forEach(p => {
                if(p.uid !== uid && role !== "User") {
                    html += `<div style="margin-bottom:10px; border-bottom:1px solid #334155; padding-bottom:5px;">
                        <b>${name}</b> <small>(${p.role})</small><br>
                        <button class="admin-btn" style="background:orange" onclick="punish('kick','${p.uid}')">è¿½æ”¾</button>
                        <button class="admin-btn" style="background:red" onclick="siteBan('${p.uid}','${name}')">ã‚µã‚¤ãƒˆBAN</button>
                    </div>`;
                } else if(p.uid === uid || role === "User") {
                    html += `<div style="margin-bottom:10px; border-bottom:1px solid #334155; padding-bottom:5px;"><b>${name}</b> <small>(${p.role})</small></div>`;
                }
            });
        }
        document.getElementById('user-ctrl-list').innerHTML = html;
    }

    async function siteBan(tUid, tName) { if(confirm(tName+" ã‚’BANï¼Ÿ")) await _sb.from('banned_users').insert([{ uid: tUid, user_name: tName }]); }
    async function updateBlacklistUI() { if(role === "User") return; const { data } = await _sb.from('banned_users').select('*'); document.getElementById('blacklist-ui').innerHTML = data.map(u => `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${u.user_name}</span><button class="admin-btn" style="background:green" onclick="unban('${u.uid}')">è§£é™¤</button></div>`).join('') || "ãªã—"; }
    async function unban(tUid) { await _sb.from('banned_users').delete().eq('uid', tUid); }
    function punish(type, target) { channel.send({ type: 'broadcast', event: type, payload: { uid: target } }); }
    async function send() { const c = document.getElementById('chat-in').value; if(c && curRoomId) { await _sb.from('messages').insert([{ room_id: curRoomId, user_name: myName, content: c }]); document.getElementById('chat-in').value = ''; } }
    async function createRoom() { const n = document.getElementById('r-name').value, p = document.getElementById('r-pass').value; if(n) { await _sb.from('rooms').insert([{ name: n, password: p || null, host_id: myName }]); document.getElementById('r-name').value = ''; document.getElementById('r-pass').value = ''; } }
    
    // éƒ¨å±‹å‰Šé™¤ã®ä¿®æ­£
    async function delRoom() { 
        if(!curRoomId) return;
        if(confirm("ã“ã®éƒ¨å±‹ã‚’å®Œå…¨ã«æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { 
            const targetId = curRoomId; 
            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å‰Šé™¤
            const { error } = await _sb.from('rooms').delete().eq('id', targetId);
            if(error) {
                alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
            } else {
                clearChat(); // UIãƒªã‚»ãƒƒãƒˆ
                getRooms();  // ãƒªã‚¹ãƒˆæ›´æ–°
            }
        } 
    }

    function nameUpdate() { myName = document.getElementById('u-name').value; localStorage.setItem('userName', myName); if(curRoomId) syncPresence(); }
    function copyDiscord() { navigator.clipboard.writeText('dr.3ko_'); alert("Discord IDã‚³ãƒ”ãƒ¼å®Œäº†"); }

    window.onload = async () => { await checkSiteBan(); getRooms(); if(role !== "User") applyRole(role); };
</script>
</body>
</html>