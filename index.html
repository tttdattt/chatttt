<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚·ãƒ³ãƒ—ãƒ«ãƒãƒ£ãƒƒãƒˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --text: #f8fafc; --accent: #38bdf8; --danger: #ef4444; --fuku: #f59e0b; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); display: grid; grid-template-columns: 320px 1fr 350px; height: 100vh; overflow: hidden; }
        section { background: var(--panel); display: flex; flex-direction: column; border-right: 1px solid #334155; overflow: hidden; }
        .header { padding: 20px; border-bottom: 1px solid #334155; font-weight: bold; background: rgba(0,0,0,0.1); }
        .scroll { flex: 1; overflow-y: auto; padding: 20px; scrollbar-width: none; }
        .scroll::-webkit-scrollbar { display: none; }
        .date-divider { text-align: center; margin: 20px 0; font-size: 0.75rem; opacity: 0.6; }
        .msg-container { display: flex; flex-direction: column; margin-bottom: 15px; }
        .u-name-label { font-size: 0.7rem; opacity: 0.7; margin: 0 10px 4px 10px; }
        .msg-bubble { display: flex; align-items: flex-end; gap: 6px; }
        .mine { align-items: flex-end; }
        .mine .msg-bubble { flex-direction: row-reverse; }
        .text { padding: 10px 16px; border-radius: 18px; max-width: 70%; font-size: 0.95rem; word-break: break-all; }
        .mine .text { background: var(--accent); color: #000; border-bottom-right-radius: 4px; }
        .other .text { background: #334155; color: #fff; border-bottom-left-radius: 4px; }
        .msg-img { max-width: 200px; max-height: 200px; border-radius: 12px; margin-top: 5px; cursor: pointer; display: block; }
        .time { font-size: 0.65rem; opacity: 0.6; min-width: 35px; }
        .card { background: #0f172a; padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #334155; }
        input[type="text"], input[type="password"] { width: 100%; padding: 10px; margin-bottom: 10px; background: #0f172a; color: white; border: 1px solid #334155; box-sizing: border-box; border-radius: 8px; }
        .btn { width: 100%; background: var(--accent); color: #000; border: none; padding: 10px; cursor: pointer; font-weight: bold; border-radius: 8px; }
        .admin-btn { font-size: 0.65rem; padding: 4px 8px; cursor: pointer; border-radius: 4px; border: none; color: white; margin: 2px; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; margin-bottom: 10px; cursor: pointer; }
        .hidden { display: none !important; }
        
        .input-wrapper { display: flex; gap: 10px; align-items: center; background: var(--panel); padding: 20px; }
        .file-btn { background: #334155; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; width: 45px; height: 45px; flex-shrink: 0; }
        #chat-in { margin-bottom: 0 !important; }
    </style>
</head>
<body>

<section>
    <div class="header">éƒ¨å±‹ä¸€è¦§</div>
    <div class="scroll">
        <div class="card">
            <input type="text" id="r-name" placeholder="éƒ¨å±‹å">
            <input type="password" id="r-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(ä»»æ„)">
            <button class="btn" onclick="createRoom()">ï¼‹ éƒ¨å±‹ä½œæˆ</button>
        </div>
        <div id="room-list"></div>
    </div>
</section>

<section style="background:#0f172a;">
    <div id="room-title" class="header">éƒ¨å±‹ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
    <div id="msg-list" class="scroll"></div>
    <div id="input-area" class="hidden input-wrapper">
        <button class="file-btn" onclick="document.getElementById('file-in').click()">ğŸ“</button>
        <input type="file" id="file-in" class="hidden" accept="image/*" onchange="uploadImage(this)">
        <input type="text" id="chat-in" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." onkeypress="if(event.key==='Enter') send()">
    </div>
</section>

<section>
    <div class="header">è¨­å®šã¨ç®¡ç†</div>
    <div class="scroll">
        <div id="ban-display" class="card hidden" style="border-color:var(--danger);color:var(--danger);text-align:center;font-weight:bold;">âš ï¸ ã‚µã‚¤ãƒˆæ©Ÿèƒ½åˆ¶é™ä¸­</div>
        <div id="role-badge-area" class="hidden" style="text-align:center;"></div>
        <div class="card"><h4>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h4><input type="text" id="u-name" value="" onchange="nameUpdate()"></div>
        <div id="auth-box" class="card"><h4>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h4><input type="password" id="a-code" placeholder="æš—å·å…¥åŠ›"><button class="btn" onclick="auth()">èªè¨¼</button></div>
        <div id="admin-tools" class="hidden">
            <div id="room-action-area" class="card hidden"><button class="btn" style="background:var(--danger);color:#fff;" onclick="delRoom()">ğŸ—‘ï¸ ã“ã®éƒ¨å±‹ã‚’å‰Šé™¤</button></div>
            <div class="card"><p style="font-size:0.8rem; cursor:pointer;" onclick="copyDiscord()">ğŸ“ å•ã„åˆã‚ã›: <span style="color:var(--accent)">dr.3ko_</span></p></div>
            <div class="card"><h4>æ¥ç¶šä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼</h4><div id="user-ctrl-list" style="font-size:0.75rem;"></div></div>
            <div class="card" style="border-color:var(--danger)"><h4>ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h4><div id="blacklist-ui" style="font-size:0.75rem;"></div></div>
            <div style="text-align:center; font-size:0.8rem; opacity:0.7; margin-top:20px;">ğŸ‘‘ ç·è²¬ä»»è€…: ãƒ€ãƒƒãƒˆ</div>
        </div>
    </div>
</section>

<script>
    const _sb = supabase.createClient('https://qvwfhesfjylkgmoscwsa.supabase.co', 'sb_publishable_Z-TH5yMPqJDGn2WGlzGrEQ_y8t-QAg8');
    let uid = localStorage.getItem('uid') || 'u-'+Math.random().toString(36).substr(2,9);
    localStorage.setItem('uid', uid);
    
    // ä¿®æ­£ç®‡æ‰€ï¼šUser + 5æ¡ã®ãƒ©ãƒ³ãƒ€ãƒ æ•°å­— (ä¾‹: User04821)
    let myName = localStorage.getItem('userName') || 'User' + Math.floor(Math.random() * 100000).toString().padStart(5, '0');
    
    let role = localStorage.getItem('userRole') || "User";
    let isSiteBanned = false, bannedRooms = JSON.parse(localStorage.getItem('br') || '[]'), curRoomId = null, roomChannel = null;
    
    // ç”»é¢ã®å…¥åŠ›æ¬„ã«åæ˜ 
    document.getElementById('u-name').value = myName;

    _sb.channel('db-sync')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => fetchMessages())
        .on('postgres_changes', { event: '*', schema: 'public', table: 'rooms' }, () => getRooms())
        .on('postgres_changes', { event: '*', schema: 'public', table: 'bans' }, () => { checkSiteBan(); updateBlacklistUI(); })
        .subscribe();

    async function checkSiteBan() {
        const { data } = await _sb.from('bans').select('user_name').eq('user_name', myName).single();
        isSiteBanned = !!data;
        document.getElementById('ban-display').classList.toggle('hidden', !isSiteBanned);
        if(isSiteBanned) clearChat();
    }

    async function getRooms() {
        const { data } = await _sb.from('rooms').select('*').order('created_at', { ascending: false });
        if(!data) return;
        document.getElementById('room-list').innerHTML = data.map(r => `
            <div class="card" onclick="joinRoom('${r.id}','${r.name}','${r.password}')" style="cursor:pointer;">
                <b>${r.name}</b> ${ (r.password && r.password.trim() !== "") ? 'ğŸ”’' : ''}
            </div>`).join('');
    }

    function auth() {
        const c = document.getElementById('a-code').value;
        if(c === 'datto0n0can') applyRole("Admin");
        else if(c === 'datto0n0fuku') applyRole("Fuku");
        else alert("ç„¡åŠ¹ãªã‚³ãƒ¼ãƒ‰");
    }

    function applyRole(newRole) {
        role = newRole; localStorage.setItem('userRole', role);
        const badge = document.getElementById('role-badge-area');
        badge.innerHTML = `<span class="badge" style="background:${role === "Admin" ? 'var(--danger)' : 'var(--fuku)'}; color:white;" onclick="logout()">${role === "Admin" ? 'ğŸ”´ ADMIN' : 'ğŸŸ  SUB ADMIN'} (Logout)</span>`;
        badge.classList.remove('hidden');
        document.getElementById('admin-tools').classList.remove('hidden');
        document.getElementById('auth-box').classList.add('hidden');
        updateBlacklistUI();
    }

    function logout() { if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem('userRole'); location.reload(); } }

    async function joinRoom(id, n, p) {
        if(isSiteBanned) return alert("BANä¸­");
        if(bannedRooms.includes(id)) return alert("è¿½æ”¾ä¸­");
        if(p && p !== "null" && p.trim() !== "" && role === "User") { 
            const inputP = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼š"); 
            if(inputP !== p) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™"); 
        }
        curRoomId = id;
        document.getElementById('room-title').innerText = n;
        document.getElementById('input-area').classList.remove('hidden');
        if(role !== "User") document.getElementById('room-action-area').classList.remove('hidden');
        if(roomChannel) _sb.removeChannel(roomChannel);
        fetchMessages();
        roomChannel = _sb.channel(`presence-${id}`, { config: { presence: { key: myName } } })
            .on('presence', { event: 'sync' }, () => updatePresenceUI())
            .on('broadcast', { event: 'kick' }, p => { if(p.payload.uid === uid) { bannedRooms.push(id); localStorage.setItem('br', JSON.stringify(bannedRooms)); clearChat(); } })
            .subscribe(async (s) => { if(s === 'SUBSCRIBED') await roomChannel.track({ uid, role }); });
    }

    async function fetchMessages() {
        if(!curRoomId) return;
        const { data } = await _sb.from('messages').select('*').eq('room_id', curRoomId).order('created_at', { ascending: true });
        if(!data) return;
        let html = "", lastDate = null;
        data.forEach(m => {
            const d = new Date(m.created_at).toLocaleDateString();
            if(d !== lastDate) { html += `<div class="date-divider">${d}</div>`; lastDate = d; }
            const t = new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const contentHtml = m.image_url ? `<img src="${m.image_url}" class="msg-img" onclick="window.open(this.src)">` : `<div class="text">${m.content}</div>`;
            html += `<div class="msg-container ${m.user_name === myName ? 'mine' : 'other'}"><div class="u-name-label">${m.user_name}</div><div class="msg-bubble">${contentHtml}<div class="time">${t}</div></div></div>`;
        });
        const list = document.getElementById('msg-list');
        list.innerHTML = html;
        list.scrollTop = list.scrollHeight;
    }

    async function uploadImage(input) {
        if(!input.files || input.files.length === 0 || !curRoomId) return;
        const file = input.files[0];
        const ext = file.name.split('.').pop();
        const path = `${Date.now()}.${ext}`;
        const { data, error } = await _sb.storage.from('images').upload(path, file);
        if(error) return alert("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ï¼š" + error.message);
        const { data: urlData } = _sb.storage.from('images').getPublicUrl(path);
        await _sb.from('messages').insert([{ room_id: curRoomId, user_name: myName, image_url: urlData.publicUrl }]);
        input.value = '';
    }

    function updatePresenceUI() {
        if(!roomChannel) return;
        const state = roomChannel.presenceState();
        let html = "";
        for (const name in state) {
            state[name].forEach(p => {
                html += `<div style="margin-bottom:8px; border-bottom:1px solid #334155;">
                    <b>${name}</b> <small>(${p.role})</small><br>
                    ${role !== "User" && p.uid !== uid ? `<button class="admin-btn" style="background:orange" onclick="punish('kick','${p.uid}')">è¿½æ”¾</button><button class="admin-btn" style="background:red" onclick="siteBan('${name}')">ã‚µã‚¤ãƒˆBAN</button>` : ''}
                </div>`;
            });
        }
        document.getElementById('user-ctrl-list').innerHTML = html;
    }

    async function send() {
        const c = document.getElementById('chat-in').value;
        if(c && curRoomId) {
            document.getElementById('chat-in').value = '';
            await _sb.from('messages').insert([{ room_id: curRoomId, user_name: myName, content: c }]);
        }
    }

    async function createRoom() {
        const n = document.getElementById('r-name').value, p = document.getElementById('r-pass').value;
        if(!n) return alert("éƒ¨å±‹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        await _sb.from('rooms').insert([{ name: n, password: p || null, host_id: myName }]);
        document.getElementById('r-name').value = ''; document.getElementById('r-pass').value = '';
    }
    
    async function delRoom() { if(confirm("å‰Šé™¤ï¼Ÿ")) { await _sb.from('rooms').delete().eq('id', curRoomId); clearChat(); } }
    function clearChat() { curRoomId = null; document.getElementById('room-title').innerText = "éƒ¨å±‹ã‚’é¸æŠã—ã¦ãã ã•ã„"; document.getElementById('msg-list').innerHTML = ""; document.getElementById('input-area').classList.add('hidden'); document.getElementById('room-action-area').classList.add('hidden'); }
    function nameUpdate() { myName = document.getElementById('u-name').value; localStorage.setItem('userName', myName); checkSiteBan(); }
    function copyDiscord() { navigator.clipboard.writeText('dr.3ko_'); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }
    function punish(type, target) { roomChannel.send({ type: 'broadcast', event: type, payload: { uid: target } }); }
    async function siteBan(tName) { if(confirm(tName+" ã‚’BANã—ã¾ã™ã‹ï¼Ÿ")) await _sb.from('bans').insert([{ user_name: tName }]); }
    async function updateBlacklistUI() { if(role === "User") return; const { data } = await _sb.from('bans').select('*'); document.getElementById('blacklist-ui').innerHTML = data.map(u => `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${u.user_name}</span><button class="admin-btn" style="background:green" onclick="unban('${u.user_name}')">è§£é™¤</button></div>`).join('') || "ãªã—"; }
    async function unban(tName) { await _sb.from('bans').delete().eq('user_name', tName); }
    window.onload = () => { getRooms(); checkSiteBan(); if(role !== "User") applyRole(role); };
</script>
</body>
</html>