<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚·ãƒ³ãƒ—ãƒ«ãƒãƒ£ãƒƒãƒˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --text: #f8fafc; --accent: #38bdf8; --danger: #ef4444; --fuku: #f59e0b; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); display: grid; grid-template-columns: 320px 1fr 350px; height: 100vh; overflow: hidden; }
        section { background: var(--panel); display: flex; flex-direction: column; border-right: 1px solid #334155; overflow: hidden; }
        .header { padding: 20px; border-bottom: 1px solid #334155; font-weight: bold; background: rgba(0,0,0,0.1); }
        .scroll { flex: 1; overflow-y: auto; padding: 20px; scrollbar-width: none; }
        .scroll::-webkit-scrollbar { display: none; }
        .date-divider { text-align: center; margin: 20px 0; font-size: 0.75rem; opacity: 0.6; }
        .msg-container { display: flex; flex-direction: column; margin-bottom: 15px; }
        .u-name-label { font-size: 0.7rem; opacity: 0.7; margin: 0 10px 4px 10px; }
        .msg-bubble { display: flex; align-items: flex-end; gap: 6px; }
        .mine { align-items: flex-end; }
        .mine .msg-bubble { flex-direction: row-reverse; }
        .text { padding: 10px 16px; border-radius: 18px; max-width: 70%; font-size: 0.95rem; word-break: break-all; }
        .mine .text { background: var(--accent); color: #000; border-bottom-right-radius: 4px; }
        .other .text { background: #334155; color: #fff; border-bottom-left-radius: 4px; }
        .time { font-size: 0.65rem; opacity: 0.6; min-width: 35px; }
        .card { background: #0f172a; padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #334155; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; background: #0f172a; color: white; border: 1px solid #334155; box-sizing: border-box; border-radius: 8px; }
        .btn { width: 100%; background: var(--accent); color: #000; border: none; padding: 10px; cursor: pointer; font-weight: bold; border-radius: 8px; }
        .admin-btn { font-size: 0.65rem; padding: 4px 8px; cursor: pointer; border-radius: 4px; border: none; color: white; margin: 2px; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; margin-bottom: 10px; cursor: pointer; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<section>
    <div class="header">Rooms</div>
    <div class="scroll">
        <div class="card">
            <input type="text" id="r-name" placeholder="éƒ¨å±‹å">
            <input type="password" id="r-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(ä»»æ„)">
            <button class="btn" onclick="createRoom()">ï¼‹ éƒ¨å±‹ä½œæˆ</button>
        </div>
        <div id="room-list"></div>
    </div>
</section>

<section style="background:#0f172a;">
    <div id="room-title" class="header">éƒ¨å±‹ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
    <div id="msg-list" class="scroll"></div>
    <div id="input-area" class="hidden" style="padding:20px; background:var(--panel);">
        <input type="text" id="chat-in" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." onkeypress="if(event.key==='Enter') send()">
    </div>
</section>

<section>
    <div class="header">Settings & Admin</div>
    <div class="scroll">
        <div id="ban-display" class="card hidden" style="border-color:var(--danger);color:var(--danger);text-align:center;font-weight:bold;">âš ï¸ ã‚µã‚¤ãƒˆæ©Ÿèƒ½åˆ¶é™ä¸­</div>
        <div id="role-badge-area" class="hidden" style="text-align:center;"></div>
        <div class="card"><h4>Profile</h4><input type="text" id="u-name" value="Dat" onchange="nameUpdate()"></div>
        <div id="auth-box" class="card"><h4>Admin Login</h4><input type="password" id="a-code" placeholder="æš—å·å…¥åŠ›"><button class="btn" onclick="auth()">èªè¨¼</button></div>
        <div id="admin-tools" class="hidden">
            <div id="room-action-area" class="card hidden"><button class="btn" style="background:var(--danger);color:#fff;" onclick="delRoom()">ğŸ—‘ï¸ ã“ã®éƒ¨å±‹ã‚’å‰Šé™¤</button></div>
            <div class="card"><p style="font-size:0.8rem; cursor:pointer;" onclick="copyDiscord()">ğŸ“ å•ã„åˆã‚ã›: <span style="color:var(--accent)">dr.3ko_</span></p></div>
            <div class="card"><h4>Realtime Users</h4><div id="user-ctrl-list" style="font-size:0.75rem;"></div></div>
            <div class="card" style="border-color:var(--danger)"><h4>Blacklist (Bans)</h4><div id="blacklist-ui" style="font-size:0.75rem;"></div></div>
        </div>
    </div>
</section>

<script>
    const _sb = supabase.createClient('https://qvwfhesfjylkgmoscwsa.supabase.co', 'sb_publishable_Z-TH5yMPqJDGn2WGlzGrEQ_y8t-QAg8');
    let uid = localStorage.getItem('uid') || 'u-'+Math.random().toString(36).substr(2,9);
    localStorage.setItem('uid', uid);
    
    let role = localStorage.getItem('userRole') || "User";
    let isSiteBanned = false, bannedRooms = JSON.parse(localStorage.getItem('br') || '[]'), myName = localStorage.getItem('userName') || "Dat", curRoomId = null, roomChannel = null;

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ
    _sb.channel('global-sync')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => fetchMessages())
        .on('postgres_changes', { event: '*', schema: 'public', table: 'rooms' }, () => getRooms())
        .on('postgres_changes', { event: '*', schema: 'public', table: 'bans' }, () => { checkSiteBan(); updateBlacklistUI(); })
        .subscribe();

    async function checkSiteBan() {
        const { data } = await _sb.from('bans').select('user_name').eq('user_name', myName).single();
        isSiteBanned = !!data;
        document.getElementById('ban-display').classList.toggle('hidden', !isSiteBanned);
    }

    async function getRooms() {
        const { data } = await _sb.from('rooms').select('*').order('created_at', { ascending: false });
        document.getElementById('room-list').innerHTML = data.map(r => `
            <div class="card" onclick="joinRoom('${r.id}','${r.name}','${r.password}')" style="cursor:pointer;">
                <b>${r.name}</b> ${ (r.password && r.password !== "null") ? 'ğŸ”’' : ''}
            </div>`).join('');
    }

    function auth() {
        const c = document.getElementById('a-code').value;
        if(c === 'datto0n0can') applyRole("Admin");
        else if(c === 'datto0n0fuku') applyRole("Fuku");
        else alert("Invalid");
    }

    function applyRole(newRole) {
        role = newRole; localStorage.setItem('userRole', role);
        const badge = document.getElementById('role-badge-area');
        badge.innerHTML = `<span class="badge" style="background:${role === "Admin" ? 'var(--danger)' : 'var(--fuku)'}; color:white;" onclick="logout()">${role === "Admin" ? 'ğŸ”´ ADMIN' : 'ğŸŸ  SUB ADMIN'}</span>`;
        badge.classList.remove('hidden');
        document.getElementById('admin-tools').classList.remove('hidden');
        document.getElementById('auth-box').classList.add('hidden');
        updateBlacklistUI();
    }

    function logout() { localStorage.removeItem('userRole'); location.reload(); }

    async function joinRoom(id, n, p) {
        if(isSiteBanned) return alert("BANä¸­");
        if(bannedRooms.includes(id)) return alert("è¿½æ”¾ä¸­");
        if(p && p !== "null" && p !== "" && role === "User") { 
            const inputP = prompt("Password:"); 
            if(inputP !== p) return alert("Wrong"); 
        }
        
        curRoomId = id;
        document.getElementById('room-title').innerText = n;
        document.getElementById('input-area').classList.remove('hidden');
        if(role !== "User") document.getElementById('room-action-area').classList.remove('hidden');

        if(roomChannel) _sb.removeChannel(roomChannel);
        fetchMessages();

        roomChannel = _sb.channel(`presence-${id}`, { config: { presence: { key: myName } } })
            .on('presence', { event: 'sync' }, () => updatePresenceUI())
            .on('broadcast', { event: 'kick' }, p => { if(p.payload.uid === uid) { bannedRooms.push(id); localStorage.setItem('br', JSON.stringify(bannedRooms)); clearChat(); } })
            .subscribe(async (s) => { if(s === 'SUBSCRIBED') await roomChannel.track({ uid, role }); });
    }

    async function fetchMessages() {
        if(!curRoomId) return;
        const { data } = await _sb.from('messages').select('*').eq('room_id', curRoomId).order('created_at', { ascending: true });
        let html = "", lastDate = null;
        data.forEach(m => {
            const d = new Date(m.created_at).toLocaleDateString();
            if(d !== lastDate) { html += `<div class="date-divider">${d}</div>`; lastDate = d; }
            const t = new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            html += `<div class="msg-container ${m.user_name === myName ? 'mine' : 'other'}"><div class="u-name-label">${m.user_name}</div><div class="msg-bubble"><div class="text">${m.content}</div><div class="time">${t}</div></div></div>`;
        });
        const list = document.getElementById('msg-list');
        list.innerHTML = html;
        list.scrollTop = list.scrollHeight;
    }

    function updatePresenceUI() {
        if(!roomChannel) return