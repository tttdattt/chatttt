<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>ã‚·ãƒ³ãƒ—ãƒ«ãƒãƒ£ãƒƒãƒˆ</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --bg:#0f172a; --panel:#1e293b; --text:#f8fafc; --accent:#38bdf8; --accent-contrast:#062033;
  --danger:#ef4444; --fuku:#f59e0b; --muted:#94a3b8; --card-bg:#0f172a;
  --fab-size:52px; --fab-margin:10px;
}
body.light-theme{ --bg:#f8fafc; --panel:#ffffff; --text:#0b1220; --accent:#0ea5e9; --accent-contrast:#063a52; --danger:#dc2626; --fuku:#d97706; --muted:#6b7280; --card-bg:#ffffff; }
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, "Noto Sans JP", system-ui, sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;}

/* Layout */
.chat-full{display:flex;flex-direction:column;height:100vh;width:100vw;}
.room-header{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);}
.title{font-weight:700;font-size:1rem}
.header-meta{font-size:0.8rem; color:var(--muted); opacity:0.85;}

/* Chat body */
.body-scroll{flex:1;overflow:auto;padding:16px;scrollbar-width:none}
.body-scroll::-webkit-scrollbar{display:none}
.msg-container{display:flex;flex-direction:column;margin-bottom:12px}
.u-name-label{font-size:0.75rem;opacity:0.85;margin:0 8px 4px 8px;font-weight:500}
.msg-bubble{display:flex;align-items:flex-end;gap:5px}
.mine{align-items:flex-end}
.mine .msg-bubble{flex-direction:row-reverse}
.text{padding:8px 14px;border-radius:16px;max-width:70%;font-size:0.9rem;word-break:break-all;background:#334155;color:#fff;border-bottom-left-radius:3px;line-height:1.4}
.mine .text{background:var(--accent);color:var(--accent-contrast);border-bottom-right-radius:3px}
.time{font-size:0.65rem;opacity:0.55;min-width:32px}

/* Input - ç¸¦ç”»é¢ã§ç´°ã */
.input-area{display:flex;gap:8px;align-items:center;padding:8px 10px;border-top:1px solid rgba(255,255,255,0.03);background:var(--panel)}
input[type="text"]{flex:1;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);outline:none;font-size:0.9rem}
.btn{background:var(--accent);color:var(--accent-contrast);border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:600;transition:transform .14s ease, box-shadow .14s ease;font-size:0.9rem;white-space:nowrap}
.pill{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:7px 10px;border-radius:999px;cursor:pointer;color:var(--text);transition:transform .14s ease, box-shadow .14s ease;font-size:0.85rem}
.tiny-note{font-size:0.8rem;color:var(--muted);margin-top:6px}

/* Hover/Focus */
button, .btn, .pill { outline:none; }
button:hover, .btn:hover, .pill:hover { transform: translateY(-3px); box-shadow:0 12px 40px rgba(2,6,23,0.4); border-color:var(--accent); }
button:focus, .btn:focus, .pill:focus { box-shadow:0 0 0 3px rgba(56,189,248,0.15); }

/* FABs */
.fab-left, .fab-right{
  position:fixed; width:var(--fab-size); height:var(--fab-size); border-radius:50%;
  display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 18px 50px rgba(0,0,0,0.45);
  z-index:1300; background:var(--panel); border:1px solid rgba(255,255,255,0.06); color:var(--text); font-weight:700;font-size:1.1rem;
  transition:transform .14s ease, box-shadow .14s ease;
}
.fab-left{ left:var(--fab-margin); }
.fab-right{ right:var(--fab-margin); }
.fab-left:hover, .fab-right:hover{transform:translateY(-4px);box-shadow:0 24px 60px rgba(0,0,0,0.5)}

/* overlay - ç¸¦ç”»é¢ã§ã‚ˆã‚Šå¤§ãã */
.overlay{
  position:fixed; opacity:0; pointer-events:none; transform: translateY(-6px); transition: opacity .18s ease, transform .18s ease;
  width: min(440px, 88vw); max-height:80vh; overflow:auto; border-radius:12px; background:var(--panel); border:1px solid rgba(0,0,0,0.4);
  box-shadow:0 32px 100px rgba(2,6,23,0.55); z-index:1400;
}
.overlay.visible{ opacity:1; pointer-events:auto; transform: translateY(0); }
.overlay header{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:space-between;font-weight:600}
.overlay .body{padding:12px;color:var(--text)}
.room-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.room-card{background:var(--card-bg);border:1px solid rgba(255,255,255,0.04);padding:10px 12px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;transition:border-color .2s ease}
.room-card:hover{border-color:rgba(56,189,248,0.3)}

/* Responsive - ç¸¦ç”»é¢ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ã•ã‚‰ã«å¤§ãã */
@media (max-width:700px){
  .fab-left{ left:8px; }
  .fab-right{ right:8px; }
  .overlay{ width:96vw; left:2vw !important; right:2vw !important; top:8vh !important; max-height:84vh; transform:none !important; }
  .input-area{padding:6px 8px}
  input[type="text"]{padding:7px 9px;font-size:0.85rem}
  .btn{padding:7px 12px;font-size:0.85rem}
  .pill{padding:6px 9px;font-size:0.8rem}
}
</style>
</head>
<body>
<div class="chat-full">
  <div id="header" class="room-header">
    <div class="title" id="room-title">éƒ¨å±‹ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
    <div id="header-right" class="header-meta"></div>
  </div>

  <div id="msg-list" class="body-scroll"></div>

  <div id="input-area" class="input-area" style="display:none">
    <button class="pill" onclick="document.getElementById('file-in').click()">ğŸ“</button>
    <input type="file" id="file-in" style="display:none" accept="image/*" onchange="uploadImage(this)">
    <input type="text" id="chat-in" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." onkeypress="if(event.key==='Enter') send()">
    <button class="btn" id="send-btn" onclick="send()">é€ä¿¡</button>
  </div>
</div>

<!-- FABs -->
<button id="fab-left" class="fab-left" aria-haspopup="dialog" aria-expanded="false" title="éƒ¨å±‹ã‚’é–‹ã">ğŸ </button>
<button id="fab-right" class="fab-right" aria-haspopup="dialog" aria-expanded="false" title="è¨­å®š">âš™ï¸</button>

<!-- Room overlay -->
<div id="room-overlay" class="overlay" role="dialog" aria-hidden="true">
  <header><strong>éƒ¨å±‹ä¸€è¦§ / æ–°è¦ä½œæˆ</strong></header>
  <div class="body">
    <div style="display:flex;gap:8px;margin-bottom:10px">
      <input id="r-name-overlay" placeholder="éƒ¨å±‹å" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);font-size:0.9rem">
      <input id="r-pass-overlay" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(ä»»æ„)" style="width:140px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);font-size:0.9rem">
      <button class="btn" onclick="createRoomFromOverlay()">+ ä½œæˆ</button>
    </div>
    <div class="room-list" id="overlay-room-list"></div>
  </div>
</div>

<!-- Settings overlay -->
<div id="settings-overlay" class="overlay" role="dialog" aria-hidden="true">
  <header>
    <strong>è¨­å®šã¨ç®¡ç†</strong>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="theme-toggle" class="pill" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">â˜€ï¸</button>
    </div>
  </header>
  <div class="body">
    <div id="ban-display" style="display:none;border:1px solid var(--danger);color:var(--danger);padding:10px;border-radius:8px;margin-bottom:10px;text-align:center;font-weight:700">âš ï¸ ã‚µã‚¤ãƒˆæ©Ÿèƒ½åˆ¶é™ä¸­</div>

    <div style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:600">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>
        </div>
        <div id="role-badge-area"></div>
      </div>
      <input type="text" id="u-name" placeholder="è¡¨ç¤ºå" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);margin-top:8px;font-size:0.9rem" onchange="nameUpdate()">
      <div style="margin-top:8px"><button class="btn" onclick="saveProfileDisplay()">ä¿å­˜</button></div>
    </div>

    <div style="margin-bottom:12px">
      <div style="font-weight:600">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</div>
      <div class="tiny-note">ç®¡ç†è€…ã‚³ãƒ¼ãƒ‰ã§æ¨©é™ã‚’å¾—ã¾ã™ã€‚</div>
      <input type="password" id="a-code" placeholder="æš—å·å…¥åŠ›" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);margin-top:8px;font-size:0.9rem">
      <div style="margin-top:8px"><button class="btn" onclick="auth()">èªè¨¼</button></div>
    </div>

    <div id="admin-section" style="display:none">
      <div style="font-weight:600;margin-bottom:8px">ç®¡ç†ãƒ„ãƒ¼ãƒ«</div>
      <div style="margin-bottom:8px"><div style="font-weight:500;font-size:0.9rem">æ¥ç¶šä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼</div><div id="user-ctrl-list" style="margin-top:6px"></div></div>
      <div style="margin-bottom:8px"><div style="font-weight:500;font-size:0.9rem">ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆ</div><div id="blacklist-ui" style="margin-top:6px"></div></div>
      <div style="margin-bottom:8px"><div style="font-weight:500;font-size:0.9rem">ãƒ«ãƒ¼ãƒ æ“ä½œ</div>
        <div style="margin-top:6px;display:flex;gap:8px">
          <button id="del-room-btn" class="btn" style="background:var(--danger);color:#fff;display:none" onclick="delRoom()">ã“ã®éƒ¨å±‹ã‚’å‰Šé™¤</button>
          <button id="settings-leave-btn" class="pill" style="display:none" onclick="leaveRoom()">é€€å‡º</button>
        </div>
      </div>
    </div>

    <div style="margin-top:12px;text-align:center" class="tiny-note">
      <div style="cursor:pointer;color:var(--accent)" onclick="copyDiscord()">ğŸ“ å•ã„åˆã‚ã›: dr.3ko_(ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼)</div>
      <div style="margin-top:6px;opacity:0.8">ğŸ‘‘ ç·è²¬ä»»è€…: ãƒ€ãƒƒãƒˆ</div>
    </div>
  </div>
</div>

<script>
const _sb = supabase.createClient('https://qvwfhesfjylkgmoscwsa.supabase.co', 'sb_publishable_Z-TH5yMPqJDGn2WGlzGrEQ_y8t-QAg8');

let uid = localStorage.getItem('uid') || 'u-'+Math.random().toString(36).substr(2,9);
localStorage.setItem('uid', uid);
let myName = localStorage.getItem('userName') || 'User' + Math.floor(Math.random()*100000).toString().padStart(5,'0');
let role = localStorage.getItem('userRole') || "User";
let isSiteBanned = false;
let bannedRooms = JSON.parse(localStorage.getItem('br') || '[]');
let curRoomId = null;
let roomChannel = null;

const headerEl = document.getElementById('header');
const headerRight = document.getElementById('header-right');
const fabLeft = document.getElementById('fab-left');
const fabRight = document.getElementById('fab-right');
const roomOverlay = document.getElementById('room-overlay');
const settingsOverlay = document.getElementById('settings-overlay');
const overlayRoomList = document.getElementById('overlay-room-list');
const themeToggle = document.getElementById('theme-toggle');
const uNameInput = document.getElementById('u-name');
const banDisplay = document.getElementById('ban-display');
const delRoomBtn = document.getElementById('del-room-btn');
const settingsLeaveBtn = document.getElementById('settings-leave-btn');

uNameInput.value = myName;

const savedTheme = localStorage.getItem('theme') || 'dark';
if(savedTheme === 'light') document.body.classList.add('light-theme');
updateThemeButton();

_sb.channel('db-sync')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => fetchMessages())
  .on('postgres_changes', { event: '*', schema: 'public', table: 'rooms' }, () => getRooms())
  .on('postgres_changes', { event: '*', schema: 'public', table: 'bans' }, () => { checkSiteBan(); updateBlacklistUI(); })
  .subscribe();

function positionFabsBelowHeader(){
  const hdr = headerEl.getBoundingClientRect();
  const top = Math.max(6, Math.round(hdr.bottom + 4));
  fabLeft.style.top = `${top}px`;
  fabRight.style.top = `${top}px`;
}
window.addEventListener('load', positionFabsBelowHeader);
window.addEventListener('resize', () => { positionFabsBelowHeader(); adjustOpenOverlayPosition(); });

fabLeft.addEventListener('click', () => {
  if(roomOverlay.classList.contains('visible')) closeOverlay(roomOverlay);
  else openOverlayAtButton(roomOverlay, fabLeft, 'right');
});
fabRight.addEventListener('click', () => {
  if(settingsOverlay.classList.contains('visible')) closeOverlay(settingsOverlay);
  else openOverlayAtButton(settingsOverlay, fabRight, 'left');
});

function openOverlayAtButton(overlay, button, side){
  if(overlay === roomOverlay) closeOverlay(settingsOverlay); else closeOverlay(roomOverlay);

  overlay.style.display = 'block';
  overlay.classList.remove('visible');
  requestAnimationFrame(() => {
    const b = button.getBoundingClientRect();
    const oRect = overlay.getBoundingClientRect();
    const margin = 8;
    let left;
    if(side === 'right'){
      left = b.right + margin;
      if(left + oRect.width > window.innerWidth - margin) left = window.innerWidth - oRect.width - margin;
    } else {
      left = b.left - oRect.width - margin;
      if(left < margin) left = margin;
    }
    let top = b.bottom + margin;
    if(top + oRect.height > window.innerHeight - margin) top = Math.max(margin, window.innerHeight - oRect.height - margin);

    overlay.style.left = `${Math.round(left)}px`;
    overlay.style.top = `${Math.round(top)}px`;
    requestAnimationFrame(()=> overlay.classList.add('visible'));
    overlay.setAttribute('aria-hidden','false');
    button.setAttribute('aria-expanded','true');
  });
}

function closeOverlay(overlay){
  overlay.classList.remove('visible');
  overlay.setAttribute('aria-hidden','true');
  if(overlay === roomOverlay) fabLeft.setAttribute('aria-expanded','false');
  if(overlay === settingsOverlay) fabRight.setAttribute('aria-expanded','false');
  setTimeout(()=> { overlay.style.display = 'none'; }, 220);
}

function adjustOpenOverlayPosition(){}

window.addEventListener('keydown', (e) => { if(e.key === 'Escape'){ closeOverlay(roomOverlay); closeOverlay(settingsOverlay); } });

themeToggle.addEventListener('click', () => {
  const isLight = document.body.classList.toggle('light-theme');
  localStorage.setItem('theme', isLight ? 'light' : 'dark');
  updateThemeButton();
});
function updateThemeButton(){ const t = localStorage.getItem('theme') || 'dark'; themeToggle.innerText = (t==='light') ? 'â˜€ï¸' : 'ğŸŒ™'; themeToggle.title = (t==='light') ? 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰' : 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰'; }

function escapeForHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeJs(s){ if(!s) return ''; return String(s).replace(/'/g,"\\'").replace(/"/g,'&quot;'); }

async function checkSiteBan(){
  const { data } = await _sb.from('bans').select('user_name').eq('user_name', myName).single();
  isSiteBanned = !!data;
  banDisplay.style.display = isSiteBanned ? 'block' : 'none';
  if(isSiteBanned) clearChat();
}

async function getRooms(){
  const { data } = await _sb.from('rooms').select('*').order('created_at', { ascending: false });
  if(!data) return;
  overlayRoomList.innerHTML = data.map(r => {
    const pwd = (r.password && r.password.trim() !== "") ? 'ğŸ”’' : 'ğŸ”“';
    return `<div class="room-card" id="overlay-room-${r.id}">
      <div>
        <div style="font-weight:600">${escapeForHtml(r.name)}</div>
        <div class="tiny-note">${pwd}</div>
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="pill" onclick="joinRoomWithConfirm('${r.id}','${escapeJs(r.name)}','${r.password ? r.password : ''}')">å…¥å®¤</button>
      </div>
    </div>`;
  }).join('');
}

async function joinRoomWithConfirm(id, name, pass){
  if(isSiteBanned) return alert('ã‚µã‚¤ãƒˆã§BANã•ã‚Œã¦ã„ã¾ã™ã€‚');
  if(bannedRooms.includes(id)) return alert('è¿½æ”¾ä¸­ã§ã™ã€‚');
  if(!pass || pass === 'null' || pass.trim() === ''){
    const ok = confirm(`éƒ¨å±‹ã€Œ${name}ã€ã«å…¥å®¤ã—ã¾ã™ã‹?`);
    if(!ok) return;
    await joinRoom(id, name, '');
    closeOverlay(roomOverlay);
  } else {
    const inputP = prompt('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„(ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ä¸­æ­¢)');
    if(inputP === null) return;
    if(inputP !== pass){ alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™'); return; }
    const ok = confirm(`ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒç¢ºèªã•ã‚Œã¾ã—ãŸã€‚éƒ¨å±‹ã€Œ${name}ã€ã«å…¥å®¤ã—ã¾ã™ã‹?`);
    if(!ok) return;
    await joinRoom(id, name, pass);
    closeOverlay(roomOverlay);
  }
}

async function joinRoom(id, n, p){
  if(isSiteBanned) return alert("BANä¸­");
  curRoomId = id;
  document.getElementById('room-title').innerText = n;
  document.getElementById('input-area').style.display = 'flex';
  delRoomBtn.style.display = 'inline-block';
  settingsLeaveBtn.style.display = 'inline-block';

  await setHeaderHostByRoomId(id);

  if(roomChannel){ try{ roomChannel.unsubscribe(); }catch(e){} roomChannel = null; }
  await fetchMessages();
  roomChannel = _sb.channel(`presence-${id}`, { config: { presence: { key: myName } } })
    .on('presence', { event: 'sync' }, () => updatePresenceUI())
    .on('broadcast', { event: 'kick' }, p => {
      if(p.payload.uid === uid){ bannedRooms.push(id); localStorage.setItem('br', JSON.stringify(bannedRooms)); clearChat(); }
    })
    .subscribe(async (s) => { if(s === 'SUBSCRIBED') await roomChannel.track({ uid, role }); });
}

async function setHeaderHostByRoomId(roomId){
  try{
    const { data } = await _sb.from('rooms').select('host_id').eq('id', roomId).single();
    if(data && data.host_id){
      headerRight.innerText = `ä½œæˆè€…: ${data.host_id}`;
      headerRight.style.opacity = '0.85';
      headerRight.style.fontSize = '0.8rem';
    } else {
      headerRight.innerText = '';
    }
  }catch(e){
    headerRight.innerText = '';
  }
}

function clearHeaderHost(){ headerRight.innerText = ''; }

async function fetchMessages(){
  if(!curRoomId) return;
  const { data } = await _sb.from('messages').select('*').eq('room_id', curRoomId).order('created_at', { ascending: true });
  if(!data) return;
  let html = "", lastDate = null;
  data.forEach(m => {
    const d = new Date(m.created_at).toLocaleDateString();
    if(d !== lastDate){ html += `<div class="tiny-note" style="text-align:center;margin:12px 0">${d}</div>`; lastDate = d; }
    const t = new Date(m.created_at).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
    const displayName = (m.user_name === myName) ? `${escapeForHtml(m.user_name)}(è‡ªåˆ†)` : escapeForHtml(m.user_name);
    const contentHtml = m.image_url ? `<img src="${m.image_url}" style="max-width:200px;border-radius:10px" onclick="window.open(this.src)">` : `<div class="text">${escapeForHtml(m.content || '')}</div>`;
    html += `<div class="msg-container ${m.user_name === myName ? 'mine' : 'other'}"><div class="u-name-label">${displayName}</div><div class="msg-bubble">${contentHtml}<div class="time">${t}</div></div></div>`;
  });
  document.getElementById('msg-list').innerHTML = html;
  document.getElementById('msg-list').scrollTop = document.getElementById('msg-list').scrollHeight;
}

async function uploadImage(input){
  if(!input.files || input.files.length===0 || !curRoomId) return;
  const file = input.files[0];
  const ext = file.name.split('.').pop();
  const path = `${Date.now()}.${ext}`;
  const { data, error } = await _sb.storage.from('images').upload(path, file);
  if(error) return alert("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:" + error.message);
  const { data: urlData } = _sb.storage.from('images').getPublicUrl(path);
  await _sb.from('messages').insert([{ room_id: curRoomId, user_name: myName, image_url: urlData.publicUrl }]);
  input.value = '';
}
async function send(){
  const c = document.getElementById('chat-in').value.trim();
  if(c && curRoomId){
    document.getElementById('chat-in').value = '';
    await _sb.from('messages').insert([{ room_id: curRoomId, user_name: myName, content: c }]);
  }
}

async function createRoomFromOverlay(){
  const n = document.getElementById('r-name-overlay').value.trim();
  const p = document.getElementById('r-pass-overlay').value;
  if(!n) return alert("éƒ¨å±‹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  await _sb.from('rooms').insert([{ name: n, password: p || null, host_id: myName }]);
  document.getElementById('r-name-overlay').value = ''; document.getElementById('r-pass-overlay').value = '';
  getRooms(); alert('éƒ¨å±‹ã‚’ä½œæˆã—ã¾ã—ãŸ');
}

async function delRoom(){
  if(!curRoomId) return alert('å‰Šé™¤ã™ã‚‹éƒ¨å±‹ã‚’é¸æŠã—ã¦ãã ã•ã„');
  if(!confirm('ã“ã®éƒ¨å±‹ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹?')) return;
  await _sb.from('rooms').delete().eq('id', curRoomId);
  clearChat();
}
function clearChat(){
  curRoomId = null;
  document.getElementById('room-title').innerText = "éƒ¨å±‹ã‚’é¸æŠã—ã¦ãã ã•ã„";
  document.getElementById('msg-list').innerHTML = "";
  document.getElementById('input-area').style.display = 'none';
  delRoomBtn.style.display = 'none';
  settingsLeaveBtn.style.display = 'none';
  clearHeaderHost();
  if(roomChannel){ try{ roomChannel.unsubscribe(); }catch(e){} roomChannel = null; }
}
function leaveRoom(){
  if(!curRoomId) return alert('ç¾åœ¨ã©ã®éƒ¨å±‹ã«ã‚‚å…¥å®¤ã—ã¦ã„ã¾ã›ã‚“');
  const ok = confirm('ã“ã®éƒ¨å±‹ã‚’é€€å‡ºã—ã¾ã™ã‹?(ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã¯æ¶ˆãˆã¾ã™)');
  if(!ok) return;
  if(roomChannel){ try{ roomChannel.unsubscribe(); }catch(e){} roomChannel = null; }
  clearChat();
}

function updatePresenceUI(){
  if(!roomChannel) return;
  const state = roomChannel.presenceState();
  let html = "";
  for(const name in state){
    state[name].forEach(p => {
      const isSelf = (name === myName);
      const nameDisplay = isSelf ? `${escapeForHtml(name)}(è‡ªåˆ†)` : escapeForHtml(name);
      html += `<div style="margin-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.04);padding-bottom:6px;">
        <b>${nameDisplay}</b> <small>(${escapeForHtml(p.role || 'User')})</small><br>
        ${role !== "User" && !isSelf ? `<button class="pill" style="background:var(--fuku);color:#000" onclick="punish('kick','${p.uid}')">è¿½æ”¾</button><button class="pill" style="background:var(--danger);color:#fff;margin-left:6px" onclick="siteBan('${escapeForHtml(name)}')">ã‚µã‚¤ãƒˆBAN</button>` : ''}
      </div>`;
    });
  }
  const el = document.getElementById('user-ctrl-list');
  if(el) el.innerHTML = html || '<div class="tiny-note">æ¥ç¶šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
}
function punish(type,target){ roomChannel && roomChannel.send({ type:'broadcast', event:type, payload:{ uid: target } }); }
async function siteBan(tName){ if(confirm(tName + " ã‚’ã‚µã‚¤ãƒˆBANã—ã¾ã™ã‹?")){ await _sb.from('bans').insert([{ user_name: tName }]); } }

async function updateBlacklistUI(){
  if(role === "User") return;
  const { data } = await _sb.from('bans').select('*');
  const el = document.getElementById('blacklist-ui');
  if(el) el.innerHTML = data.map(u => `<div style="display:flex;justify-content:space-between;margin-bottom:6px;"><span>${escapeForHtml(u.user_name)}</span><button class="pill" onclick="unban('${escapeForHtml(u.user_name)}')">è§£é™¤</button></div>`).join('') || '<div class="tiny-note">ãªã—</div>';
}
async function unban(tName){ await _sb.from('bans').delete().eq('user_name', tName); updateBlacklistUI(); }

function nameUpdate(){ myName = document.getElementById('u-name').value || myName; localStorage.setItem('userName', myName); checkSiteBan(); }
function saveProfileDisplay(){ const v = document.getElementById('u-name').value.trim(); if(v){ myName = v; localStorage.setItem('userName', v); checkSiteBan(); alert('è¡¨ç¤ºåã‚’ä¿å­˜ã—ã¾ã—ãŸ'); } }
function copyDiscord(){ navigator.clipboard.writeText('dr.3ko_'); alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }
function auth(){ const c = document.getElementById('a-code').value; if(c === 'datto0n0can'){ applyRole("Admin"); } else if(c === 'datto0n0fuku'){ applyRole("Fuku"); } else alert("ç„¡åŠ¹ãªã‚³ãƒ¼ãƒ‰"); }
function applyRole(newRole){ role = newRole; localStorage.setItem('userRole', role); document.getElementById('role-badge-area').innerHTML = `<span class="badge" style="background:${role==='Admin'?'var(--danger)':'var(--fuku)'};color:#fff;padding:4px 8px;border-radius:6px;font-size:0.75rem;font-weight:600">${role==='Admin'?'ğŸ”´ ADMIN':'ğŸŸ  SUB ADMIN'}</span>`; document.getElementById('admin-section').style.display = 'block'; updateBlacklistUI(); updatePresenceUI(); }

window.onload = () => { positionFabsBelowHeader(); getRooms(); checkSiteBan(); if(role !== 'User') applyRole(role); };

</script>
</body>
</html>