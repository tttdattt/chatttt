<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App for Dat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ã« */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        body { background-color: #f3f4f6; }
    </style>
</head>
<body class="h-screen flex flex-col font-sans text-gray-800">

    <header class="bg-blue-600 text-white p-4 shadow-md z-10">
        <h1 class="text-xl font-bold text-center">ğŸ’¬ Public Chat Room</h1>
    </header>

    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 pb-24">
        <div class="text-center text-gray-400 text-sm mt-10">èª­ã¿è¾¼ã¿ä¸­...</div>
    </main>

    <footer class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-3 shadow-lg">
        <div class="max-w-4xl mx-auto flex flex-col gap-2">
            <div class="flex items-center gap-2">
                <span class="text-xs text-gray-500 font-bold">Name:</span>
                <input type="text" id="userName" placeholder="ã‚ãªãŸã®åå‰" 
                    class="text-sm border border-gray-300 rounded px-2 py-1 outline-none focus:border-blue-500 w-32 transition">
            </div>
            
            <div class="flex gap-2">
                <input type="text" id="content" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ Enter..." 
                    class="flex-1 border border-gray-300 rounded-lg px-4 py-2 outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition"
                    onkeydown="if(event.key === 'Enter') sendMessage()">
                
                <button onclick="sendMessage()" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition shadow-md active:scale-95 flex items-center">
                    é€ä¿¡
                </button>
            </div>
        </div>
    </footer>

    <script>
        // ==========================================
        //  è¨­å®šã‚¨ãƒªã‚¢ (ãƒ€ãƒƒãƒˆã®ã‚­ãƒ¼è¨­å®šæ¸ˆã¿)
        // ==========================================
        const SUPABASE_URL = 'https://qvwfhesfjylkgmoscwsa.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_Z-TH5yMPqJDGn2WGlzGrEQ_y8t-QAg8';
        // ==========================================

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const chatContainer = document.getElementById('chat-container');
        const nameInput = document.getElementById('userName');

        // ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸæ™‚ã€å‰ã«ä½¿ã£ãŸåå‰ãŒã‚ã‚Œã°è‡ªå‹•å…¥åŠ›ã™ã‚‹
        if (localStorage.getItem('chat_username')) {
            nameInput.value = localStorage.getItem('chat_username');
        }

        // --- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ©Ÿèƒ½ ---
        async function sendMessage() {
            const user_name = nameInput.value.trim();
            const content = document.getElementById('content').value.trim();
            
            if (!user_name) return alert('åå‰ã‚’å…¥ã‚Œã¦ã­ï¼');
            if (!content) return; // ç©ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯é€ã‚‰ãªã„

            // åå‰ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ï¼ˆæ¬¡ã‹ã‚‰æ¥½ã«ãªã‚‹ï¼‰
            localStorage.setItem('chat_username', user_name);

            // Supabaseã«é€ä¿¡
            const { error } = await supabase
                .from('messages')
                .insert([{ user_name: user_name, content: content }]);

            if (error) {
                console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                alert('é€ä¿¡ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚RLSè¨­å®šã‚’ç¢ºèªã—ã¦ã­ï¼');
            } else {
                document.getElementById('content').value = ''; // å…¥åŠ›æ¬„ã‚’ç©ºã«ã™ã‚‹
                // é€ä¿¡å¾Œã®ç”»é¢æ›´æ–°ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã«ä»»ã›ã‚‹
            }
        }

        // --- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºæ©Ÿèƒ½ ---
        function displayMessage(msg) {
            const myName = nameInput.value || localStorage.getItem('chat_username');
            const isMe = msg.user_name === myName; // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã©ã†ã‹åˆ¤å®š

            const div = document.createElement('div');
            // è‡ªåˆ†ãªã‚‰å³å¯„ã›ã€ä»–äººãªã‚‰å·¦å¯„ã›ã®ã‚¯ãƒ©ã‚¹ã‚’é©ç”¨
            div.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'}`;

            // æ—¥æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (ä¾‹: 12:30)
            const time = new Date(msg.created_at).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

            div.innerHTML = `
                <div class="text-xs text-gray-500 mb-1 px-1">${isMe ? '' : msg.user_name}</div>
                <div class="max-w-[80%] px-4 py-2 rounded-2xl shadow-sm text-sm break-words 
                    ${isMe ? 'bg-blue-500 text-white rounded-tr-none' : 'bg-white text-gray-800 border border-gray-200 rounded-tl-none'}">
                    ${escapeHtml(msg.content)}
                </div>
                <div class="text-[10px] text-gray-400 mt-1 px-1">${time}</div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        // --- æœ€åˆã«å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚€ ---
        async function fetchMessages() {
            chatContainer.innerHTML = ''; // ã‚¯ãƒªã‚¢
            const { data, error } = await supabase
                .from('messages')
                .select('*')
                .order('created_at', { ascending: true });

            if (error) {
                chatContainer.innerHTML = `<div class="text-red-500 text-center mt-10">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                return;
            }

            if(data.length === 0) {
                chatContainer.innerHTML = '<div class="text-center text-gray-400 mt-10">ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>ä¸€ç•ªä¹—ã‚Šã§ãƒãƒ£ãƒƒãƒˆã—ã¦ã¿ã‚ˆã†ï¼</div>';
            } else {
                data.forEach(msg => displayMessage(msg));
            }
        }

        // --- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–° (ä»–ã®äººãŒé€ã£ãŸã‚‰ã™ãè¡¨ç¤º) ---
        supabase
            .channel('public:messages')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                // ã™ã§ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
                // ç°¡æ˜“çš„ã«ä¸€ç•ªä¸‹ã«è¿½åŠ 
                displayMessage(payload.new);
            })
            .subscribe();

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // XSSå¯¾ç­–ï¼ˆå¤‰ãªã‚³ãƒ¼ãƒ‰ã‚’åŸ‹ã‚è¾¼ã¾ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
        function escapeHtml(text) {
            if(!text) return "";
            return text.replace(/[&<>"']/g, function(m) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
            });
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        fetchMessages();
    </script>
</body>
</html>