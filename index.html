<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚·ãƒ³ãƒ—ãƒ«ãƒãƒ£ãƒƒãƒˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --text: #f8fafc; --accent: #38bdf8; --danger: #ef4444; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); display: grid; grid-template-columns: 320px 1fr 350px; height: 100vh; overflow: hidden; }
        section { background: var(--panel); display: flex; flex-direction: column; border-right: 1px solid #334155; overflow: hidden; }
        .header { padding: 20px; border-bottom: 1px solid #334155; font-weight: bold; }
        .scroll { flex: 1; overflow-y: auto; padding: 20px; scrollbar-width: none; }
        .scroll::-webkit-scrollbar { display: none; }
        
        /* ãƒãƒ£ãƒƒãƒˆè¡¨ç¤º */
        .date-divider { text-align: center; margin: 20px 0; font-size: 0.75rem; opacity: 0.6; }
        .msg-container { display: flex; flex-direction: column; margin-bottom: 15px; }
        .u-name-label { font-size: 0.7rem; opacity: 0.7; margin: 0 10px 4px 10px; }
        .msg-bubble { display: flex; align-items: flex-end; gap: 6px; }
        .mine { align-items: flex-end; }
        .mine .msg-bubble { flex-direction: row-reverse; }
        .text { padding: 10px 16px; border-radius: 18px; max-width: 70%; font-size: 0.95rem; word-break: break-all; }
        .mine .text { background: var(--accent); color: #000; border-bottom-right-radius: 4px; }
        .other .text { background: #334155; color: #fff; border-bottom-left-radius: 4px; }
        .time { font-size: 0.65rem; opacity: 0.6; min-width: 35px; }

        .card { background: #0f172a; padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #334155; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; background: #0f172a; color: white; border: 1px solid #334155; box-sizing: border-box; border-radius: 8px; }
        .btn { width: 100%; background: var(--accent); color: #000; border: none; padding: 10px; cursor: pointer; font-weight: bold; border-radius: 8px; }
        .admin-btn { font-size: 0.65rem; padding: 4px 8px; cursor: pointer; border-radius: 4px; border: none; color: white; margin: 2px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<section>
    <div class="header">Rooms</div>
    <div class="scroll">
        <div class="card">
            <input type="text" id="r-name" placeholder="éƒ¨å±‹å">
            <button class="btn" onclick="createRoom()">ï¼‹ éƒ¨å±‹ä½œæˆ</button>
        </div>
        <div id="room-list"></div>
    </div>
</section>

<section style="background:#0f172a;">
    <div id="room-title" class="header">éƒ¨å±‹ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
    <div id="msg-list" class="scroll"></div>
    <div id="input-area" class="hidden" style="padding:20px; background:var(--panel);">
        <input type="text" id="chat-in" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." onkeypress="if(event.key==='Enter') send()">
    </div>
</section>

<section>
    <div class="header">Settings</div>
    <div class="scroll">
        <div id="ban-display" class="card hidden" style="border-color:var(--danger);color:var(--danger);text-align:center;font-weight:bold;">âš ï¸ ã‚µã‚¤ãƒˆæ©Ÿèƒ½åˆ¶é™ä¸­</div>
        <div class="card"><h4>Profile</h4><input type="text" id="u-name" value="Dat" onchange="nameUpdate()"></div>
        <div id="auth-box" class="card"><h4>Admin Login</h4><input type="password" id="a-code" placeholder="æš—å·å…¥åŠ›"><button class="btn" onclick="auth()">èªè¨¼</button></div>
        <div id="admin-tools" class="hidden">
            <div class="card"><p style="font-size:0.8rem">å•ã„åˆã‚ã›: Discord dr.3ko_</p><button class="btn" style="background:var(--danger);color:#fff;" onclick="delRoom()">ğŸ—‘ï¸ éƒ¨å±‹ã‚’å‰Šé™¤</button></div>
            <div class="card"><h4>Realtime Users</h4><div id="user-ctrl-list" style="font-size:0.75rem;"></div></div>
            <div class="card" style="border-color:var(--danger)"><h4>Blacklist</h4><div id="blacklist-ui" style="font-size:0.75rem;"></div></div>
            <div style="text-align:center; font-size:0.8rem; opacity:0.7; margin-top:20px;">ğŸ‘‘ ç·è²¬ä»»è€…: ãƒ€ãƒƒãƒˆ</div>
        </div>
    </div>
</section>

<script>
    const _sb = supabase.createClient('https://qvwfhesfjylkgmoscwsa.supabase.co', 'sb_publishable_Z-TH5yMPqJDGn2WGlzGrEQ_y8t-QAg8');
    let uid = localStorage.getItem('uid') || 'u-'+Math.random().toString(36).substr(2,9);
    localStorage.setItem('uid', uid);
    
    let isSiteBanned = false, bannedRooms = JSON.parse(localStorage.getItem('br') || '[]'), role = "User", myName = "Dat", curRoomId = null, channel = null;

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨­å®š
    _sb.channel('global')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'banned_users' }, () => { checkSiteBan(); updateBlacklistUI(); })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'rooms' }, () => getRooms())
        .subscribe();

    async function checkSiteBan() {
        const { data } = await _sb.from('banned_users').select('uid').eq('uid', uid).single();
        isSiteBanned = !!data;
        document.getElementById('ban-display').classList.toggle('hidden', !isSiteBanned);
        if(isSiteBanned) {
            document.getElementById('input-area').classList.add('hidden');
            curRoomId = null;
        }
    }

    async function getRooms() {
        const { data } = await _sb.from('rooms').select('*').order('created_at', { ascending: false });
        document.getElementById('room-list').innerHTML = data.map(r => `<div class="card" onclick="joinRoom('${r.id}','${r.name}')" style="cursor:pointer;"><b>${r.name}</b></div>`).join('');
    }

    function auth() {
        const c = document.getElementById('a-code').value;
        if(c === 'datto0n0can') role = "Admin"; else if(c === 'datto0n0fuku') role = "Fuku"; else return alert("Invalid");
        document.getElementById('admin-tools').classList.remove('hidden');
        document.getElementById('auth-box').classList.add('hidden');
        updateBlacklistUI(); if(curRoomId) syncPresence();
    }

    async function joinRoom(id, n) {
        if(isSiteBanned) return alert("BANã•ã‚Œã¦ã„ã¾ã™");
        if(bannedRooms.includes(id)) return alert("ã“ã®éƒ¨å±‹ã‹ã‚‰ã¯è¿½æ”¾ã•ã‚Œã¦ã„ã¾ã™");
        
        curRoomId = id;
        document.getElementById('room-title').innerText = n;
        document.getElementById('input-area').classList.remove('hidden'); // éƒ¨å±‹ã«å…¥ã£ãŸã‚‰å…¥åŠ›ãƒãƒ¼ã‚’è¡¨ç¤º
        
        if(channel) _sb.removeChannel(channel);
        fetchMessages();

        channel = _sb.channel(`r-${id}`, { config: { presence: { key: myName } } })
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `room_id=eq.${id}` }, () => fetchMessages())
            .on('presence', { event: 'sync' }, () => updateAdminUI())
            .on('broadcast', { event: 'kick' }, p => {
                if(p.payload.uid === uid) {
                    bannedRooms.push(id); localStorage.setItem('br', JSON.stringify(bannedRooms));
                    location.reload();
                }
            })
            .on('broadcast', { event: 'allow' }, p => {
                if(p.payload.uid === uid) {
                    bannedRooms = bannedRooms.filter(i => i !== id); localStorage.setItem('br', JSON.stringify(bannedRooms));
                    alert("è¨±å¯ã•ã‚Œã¾ã—ãŸ");
                }
            })
            .subscribe(async (s) => { if(s === 'SUBSCRIBED') syncPresence(); });
    }

    async function fetchMessages() {
        if(!curRoomId) return;
        const { data } = await _sb.from('messages').select('*').eq('room_id', curRoomId).order('created_at', { ascending: true });
        const list = document.getElementById('msg-list');
        let html = "", lastDate = null;
        data.forEach(m => {
            const d = new Date(m.created_at).toLocaleDateString('ja-JP', { timeZone: 'Asia/Tokyo' });
            if(d !== lastDate) { html += `<div class="date-divider">${d}</div>`; lastDate = d; }
            const t = new Date(m.created_at).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Tokyo' });
            html += `<div class="msg-container ${m.user_name === myName ? 'mine' : 'other'}">
                <div class="u-name-label">${m.user_name}</div>
                <div class="msg-bubble"><div class="text">${m.content}</div><div class="time">${t}</div></div>
            </div>`;
        });
        list.innerHTML = html;
        list.scrollTop = list.scrollHeight;
    }

    async function syncPresence() { if(channel) await channel.track({ uid, role }); }

    function updateAdminUI() {
        if(role === "User") return;
        const state = channel.presenceState();
        let html = "";
        for (const name in state) {
            state[name].forEach(p => {
                if(p.uid === uid) return;
                html += `<div style="margin-bottom:10px;">${name} (${p.role})<br>
                    <button class="admin-btn" style="background:orange" onclick="punish('kick','${p.uid}')">è¿½æ”¾</button>
                    <button class="admin-btn" style="background:green" onclick="punish('allow','${p.uid}')">è¨±å¯</button>
                    <button class="admin-btn" style="background:red" onclick="siteBan('${p.uid}','${name}')">ã‚µã‚¤ãƒˆBAN</button>
                </div>`;
            });
        }
        document.getElementById('user-ctrl-list').innerHTML = html;
    }

    async function siteBan(tUid, tName) {
        if(confirm(tName+" ã‚’ã‚µã‚¤ãƒˆBANï¼Ÿ")) {
            await _sb.from('banned_users').insert([{ uid: tUid, user_name: tName }]);
            channel.send({ type: 'broadcast', event: 'site_ban', payload: { uid: tUid } });
        }
    }

    async function updateBlacklistUI() {
        if(role === "User") return;
        const { data } = await _sb.from('banned_users').select('*');
        document.getElementById('blacklist-ui').innerHTML = data.map(u => `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${u.user_name}</span><button class="admin-btn" style="background:green" onclick="unban('${u.uid}')">è§£é™¤</button></div>`).join('') || "ãªã—";
    }

    async function unban(tUid) { await _sb.from('banned_users').delete().eq('uid', tUid); }
    function punish(type, target) { channel.send({ type: 'broadcast', event: type, payload: { uid: target } }); }
    async function send() {
        const c = document.getElementById('chat-in').value;
        if(c && curRoomId) {
            await _sb.from('messages').insert([{ room_id: curRoomId, user_name: myName, content: c }]);
            document.getElementById('chat-in').value = '';
        }
    }
    async function createRoom() {
        const n = document.getElementById('r-name').value;
        if(n && !isSiteBanned) {
            await _sb.from('rooms').insert([{ name: n, host_id: myName }]);
            document.getElementById('r-name').value = '';
        }
    }
    function nameUpdate() { myName = document.getElementById('u-name').value; if(curRoomId) syncPresence(); }

    window.onload = async () => { await checkSiteBan(); getRooms(); };
</script>
</body>
</html>